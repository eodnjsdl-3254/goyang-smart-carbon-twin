services:
  # 1. Nginx: 게이트웨이
  nginx:
    image: nginx:alpine
    container_name: gsct-gateway
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./uploads:/usr/share/nginx/html/files:ro
    depends_on:
      - frontend   # 추가
      - backend
      - geoserver
    networks:
      - gsct-network
    restart: always

  # 2. Frontend: Vite
  frontend:
    build: ./frontend
    container_name: gsct-frontend
    volumes:
      - ./frontend:/app                # 소스 코드 동기화
      - /app/node_modules              # 의존성 보호 (익명 볼륨)
    ports:
      - "5173:5173"                    # 직접 접속용 포트 유지
    networks:
      - gsct-network
    environment:
      - CHOKIDAR_USEPOLLING=true       # WSL2 파일 변경 감지 활성화
    restart: always

  # 3. PostGIS: 공간 DB
  db:
    image: kartoza/postgis:14-3.1
    container_name: gsct-db
    environment:
      - POSTGRES_DB=gisdb
      - POSTGRES_USER=docker
      - POSTGRES_PASS=docker
      - ALLOW_IP_RANGE=0.0.0.0/0
    ports:
      - "54321:5432"
    volumes:
      - gsct-db-data:/var/lib/postgresql
    networks:
      - gsct-network
    restart: on-failure

  # 4. GeoServer: 맵 서버
  geoserver:
    image: kartoza/geoserver:2.22.0
    container_name: gsct-geoserver
    environment:
      - GEOSERVER_DATA_DIR=/opt/geoserver/data_dir
      - GEOSERVER_ADMIN_PASSWORD=geoserver
      - GEOSERVER_ADMIN_USER=admin
      - CORS_ENABLED=true
    ports:
      - "8099:8080"
    depends_on:
      - db
    volumes:
      - gsct-geoserver-data:/opt/geoserver/data_dir
    networks:
      - gsct-network
    restart: on-failure

  # 5. Backend: FastAPI
  backend:
    build: ./backend
    container_name: gsct-backend
    volumes:
      - ./uploads:/app/files
    networks:
      - gsct-network
    restart: always

volumes:
  gsct-db-data:
  gsct-geoserver-data:

networks:
  gsct-network:
    name: gsct-shared-network