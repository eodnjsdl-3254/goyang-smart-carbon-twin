events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # 1. GeoServer (내부 컨테이너 통신)
    upstream geoserver {
        server geoserver:8080;
    }

    # 2. Backend (FastAPI - API 및 변환 로직)
    upstream backend {
        server backend:8000;
    }

    # 3. Frontend (WSL2 호스트에서 실행 중인 Vite 서버)
    upstream frontend {
        # host.docker.internal은 Docker 컨테이너에서 호스트 PC(WSL2)로 접속할 때 사용
        server host.docker.internal:5173;
    }

    server {
        listen 80;
        server_name localhost;

        # A. 정적 파일 서빙 (GLB, 데이터 파일 등)
        location /files/ {
            alias /usr/share/nginx/html/files/;
            autoindex on;
            access_log off;
            expires 1d;
            add_header 'Access-Control-Allow-Origin' '*';
        }

        # B. Backend API 및 변환 요청
        # /api/로 시작하는 요청을 백엔드로 전달 (예: /api/convert)
        location /api/ {
            proxy_pass http://backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            client_max_body_size 100M;
        }

        # C. GeoServer 프록시
        location /geoserver/ {
            proxy_pass http://geoserver/geoserver/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            add_header 'Access-Control-Allow-Origin' '*';
        }

        # D. Frontend (Vite 개발 서버 연결)
        location / {
            proxy_pass http://frontend;
            proxy_set_header Host $host;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}